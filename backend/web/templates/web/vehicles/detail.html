{% extends "web/base.html" %}
{% block content %}
<p><a class="btn btn-secondary" href="{% url 'customer_list' %}">â† é¡§å®¢ä¸€è¦§ã«æˆ»ã‚‹</a></p>

<h2>è»Šä¸¡è©³ç´°</h2>

<div class="d-flex justify-content-end mb-2">
  <button id="edit-btn" class="btn btn-primary btn-sm">ç·¨é›†</button>
  <button id="save-btn" class="btn btn-success btn-sm d-none">ä¿å­˜</button>
  <button id="cancel-btn" class="btn btn-outline-secondary btn-sm d-none">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<form id="vehicle-form">
  <table class="table table-bordered table-striped">
    <tbody id="vehicle-detail">
      <tr><td colspan="2">ãƒ­ãƒ¼ãƒ‰ä¸­...</td></tr>
    </tbody>
  </table>
</form>

<h2>è»Šä¸¡ç”»åƒ</h2>
<div id="images"></div>

<form id="image-form" enctype="multipart/form-data" style="margin-top:8px">
  <input type="file" name="image" accept="image/*">
  <button type="submit" class="btn">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
</form>
<div id="image-errors" style="color:#b00"></div>

<h2>è»Šä¸¡ãƒ¡ãƒ¢</h2>

<!-- ãƒ¡ãƒ¢è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
<form id="memo-form" style="margin-bottom:12px">
  <textarea name="body" rows="3" style="width:100%;margin-bottom:6px" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea><br>
  <button type="submit" class="btn">è¿½åŠ </button>
  <div id="memo-errors" style="color:#b00"></div>
</form>

<!-- ãƒ¡ãƒ¢ä¸€è¦§ -->
<ul id="memos">
  <li class="muted">ãƒ­ãƒ¼ãƒ‰ä¸­...</li>
</ul>

<script>
const csrftoken = document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1];
const vehicleId = window.location.pathname.split("/").filter(Boolean).pop();

let vehicleData = null;
let editMode = false;

// ---- ãƒã‚¹ã‚¿ãƒ¼æ ¼ç´ ----
let masterData = { manufacturers: [], categories: [], colors: [] };

// ----------------------------------------
// åˆæœŸãƒ­ãƒ¼ãƒ‰
// ----------------------------------------
(async function init() {
  await fetchMasters();
  await fetchVehicle(vehicleId);
  await fetchImages(); // â† è»Šä¸¡ç”»åƒã‚’ãƒ­ãƒ¼ãƒ‰
})();

// ----------------------------------------
// ãƒã‚¹ã‚¿ãƒ¼APIå–å¾—
// ----------------------------------------
async function fetchMasters() {
  try {
    const [m, c, col] = await Promise.all([
      fetch("/api/masters/manufacturers/").then(r=>r.json()),
      fetch("/api/masters/vehiclecategories/").then(r=>r.json()),
      fetch("/api/masters/colors/").then(r=>r.json()),
    ]);
    masterData.manufacturers = m;
    masterData.categories = c;
    masterData.colors = col;
  } catch(e) {
    console.error("ãƒã‚¹ã‚¿ãƒ¼å–å¾—å¤±æ•—:", e);
  }
}

// ----------------------------------------
// è»Šä¸¡è©³ç´°å–å¾—
// ----------------------------------------
async function fetchVehicle(pk) {
  const res = await fetch(`/api/vehicles/${pk}/`);
  const data = await res.json();
  vehicleData = data;
  renderVehicle(data, false);
}

// ----------------------------------------
// ç·¨é›†ãƒ»ä¿å­˜ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«
// ----------------------------------------
document.getElementById("edit-btn").addEventListener("click", () => {
  editMode = true;
  renderVehicle(vehicleData, true);
  toggleButtons();
});
document.getElementById("cancel-btn").addEventListener("click", () => {
  editMode = false;
  renderVehicle(vehicleData, false);
  toggleButtons();
});
function toggleButtons() {
  document.getElementById("edit-btn").classList.toggle("d-none", editMode);
  document.getElementById("save-btn").classList.toggle("d-none", !editMode);
  document.getElementById("cancel-btn").classList.toggle("d-none", !editMode);
}

// ----------------------------------------
// ä¿å­˜å‡¦ç†
// ----------------------------------------
document.getElementById("save-btn").addEventListener("click", async () => {
  const f = new FormData(document.getElementById("vehicle-form"));

  const updated = {
    vehicle_name: f.get("vehicle_name"),
    displacement: f.get("displacement") || null,
    model_year: f.get("model_year"),
    new_car_type: f.get("new_car_type"),
    manufacturer_id: f.get("manufacturer_id") || null,
    category_id: f.get("category_id") || null,
    model_code: f.get("model_code"),
    chassis_no: f.get("chassis_no") || null,
    engine_type: f.get("engine_type"),
    color_id: f.get("color_id") || null,
    color_name: f.get("color_name"),
    color_code: f.get("color_code"),

    registrations: [{
      registation_area: f.get("registation_area"),
      registation_no: f.get("registation_no"),
      certification_no: f.get("certification_no"),
      first_registration_date: f.get("first_registration_date") || null,
      inspection_expiration: f.get("inspection_expiration") || null,
      security_registration: f.get("security_registration"),
    }],

    insurances: [
      {
        type: "mandatory",
        company: f.get("mandatory_company"),
        start_date: f.get("mandatory_start_date") || null,
        end_date: f.get("mandatory_end_date") || null,
        policy_no: f.get("mandatory_policy_no"),
      },
      {
        type: "optional",
        company: f.get("optional_company"),
        start_date: f.get("optional_start_date") || null,
        end_date: f.get("optional_end_date") || null,
        policy_no: f.get("optional_policy_no"),
      },
    ].filter(i => i.company || i.policy_no),

    warranties: [{
      start_date: f.get("warranty_start_date") || null,
      end_date: f.get("warranty_end_date") || null,
      plan_name: f.get("warranty_plan_name"),
      note: f.get("warranty_note"),
    }],
  };

  try {
    const res = await fetch(`/api/vehicles/${vehicleId}/update/`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
      body: JSON.stringify(updated),
    });
    if (!res.ok) throw new Error(`ä¿å­˜ã‚¨ãƒ©ãƒ¼ (${res.status})`);
    const data = await res.json();
    alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
    vehicleData = data;
    editMode = false;
    renderVehicle(data, false);
    toggleButtons();
  } catch (err) {
    alert("ä¿å­˜å¤±æ•—: " + err.message);
  }
});

// ----------------------------------------
// è©³ç´°ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// ----------------------------------------
function renderVehicle(v, editable=false) {
  const tbody = document.getElementById("vehicle-detail");

  const input = (n, val) => `<input class="form-control" name="${n}" value="${val ?? ""}">`;
  const date  = (n, val) => `<input type="date" class="form-control" name="${n}" value="${val ?? ""}">`;
  const sel = (n, val, opts) =>
    `<select name="${n}" class="form-select">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      ${opts.map(o => `<option value="${o.id}" ${String(o.id)===String(val)?"selected":""}>${o.name}</option>`).join("")}
    </select>`;

  tbody.innerHTML = `
  <tr><th colspan="2" class="table-secondary">åŸºæœ¬æƒ…å ±</th></tr>
  ${row("è»Šä¸¡å", "vehicle_name")}
  ${row("æ’æ°—é‡", "displacement")}
  ${row("å¹´å¼", "model_year")}
  ${row("æ–°è»Šãƒ»ä¸­å¤", "new_car_type", ["æ–°è»Š","ä¸­å¤"])}
  ${row("ãƒ¡ãƒ¼ã‚«ãƒ¼", "manufacturer_id", masterData.manufacturers)}
  ${row("ã‚«ãƒ†ã‚´ãƒªãƒ¼", "category_id", masterData.categories)}
  ${row("å‹å¼", "model_code")}
  ${row("è»Šå°ç•ªå·", "chassis_no")}
  ${row("è‰²", "color_id", masterData.colors)}
  ${row("è‰²åç§°", "color_name")}
  ${row("è‰²è¨˜å·", "color_code")}
  ${row("åŸå‹•å‹", "engine_type", ["gasoline","electric","hybrid","other"])}

  <tr><th colspan="2" class="table-secondary">ç™»éŒ²æƒ…å ±</th></tr>
  ${row("ç™»éŒ²åœ°", "registation_area", null, v.registrations?.[0])}
  ${row("ç™»éŒ²ç•ªå·", "registation_no", null, v.registrations?.[0])}
  ${row("å‹èªç•ªå·", "certification_no", null, v.registrations?.[0])}
  ${row("åˆå¹´åº¦ç™»éŒ²æ—¥", "first_registration_date", null, v.registrations?.[0])}
  ${row("è»Šæ¤œæº€äº†æ—¥", "inspection_expiration", null, v.registrations?.[0])}
  ${row("é˜²çŠ¯ç™»éŒ²", "security_registration", null, v.registrations?.[0])}

  <tr><th colspan="2" class="table-secondary">ä»»æ„ä¿é™º</th></tr>
  ${row("ä¼šç¤¾", "optional_company", null, v.insurances?.find(i=>i.type=="optional"))}
  ${row("é–‹å§‹æ—¥", "optional_start_date", null, v.insurances?.find(i=>i.type=="optional"))}
  ${row("çµ‚äº†æ—¥", "optional_end_date", null, v.insurances?.find(i=>i.type=="optional"))}
  ${row("è¨¼åˆ¸ç•ªå·", "optional_policy_no", null, v.insurances?.find(i=>i.type=="optional"))}

  <tr><th colspan="2" class="table-secondary">è‡ªè³ è²¬ä¿é™º</th></tr>
  ${row("ä¼šç¤¾", "mandatory_company", null, v.insurances?.find(i=>i.type=="mandatory"))}
  ${row("é–‹å§‹æ—¥", "mandatory_start_date", null, v.insurances?.find(i=>i.type=="mandatory"))}
  ${row("çµ‚äº†æ—¥", "mandatory_end_date", null, v.insurances?.find(i=>i.type=="mandatory"))}
  ${row("è¨¼åˆ¸ç•ªå·", "mandatory_policy_no", null, v.insurances?.find(i=>i.type=="mandatory"))}

  <tr><th colspan="2" class="table-secondary">ä¿è¨¼</th></tr>
  ${row("é–‹å§‹æ—¥", "warranty_start_date", null, v.warranties?.[0])}
  ${row("çµ‚äº†æ—¥", "warranty_end_date", null, v.warranties?.[0])}
  ${row("ãƒ—ãƒ©ãƒ³å", "warranty_plan_name", null, v.warranties?.[0])}
  ${row("å‚™è€ƒ", "warranty_note", null, v.warranties?.[0])}
  `;

  function row(label, key, options=null, src=v) {
    const val = src?.[key] ?? "";
    let field;

    if (editable) {
      if (Array.isArray(options) && options.length && options[0].id) {
        field = sel(key, val, options);
      } else if (Array.isArray(options)) {
        field = `<select name="${key}" class="form-select">
                  ${options.map(o => `<option value="${o}" ${o==val?"selected":""}>${o}</option>`).join("")}
                 </select>`;
      } else if (key.includes("date")) {
        field = date(key, val);
      } else {
        field = input(key, val);
      }
    } else {
      if (key === "manufacturer_id") field = v.manufacturer_name || "-";
      else if (key === "category_id") field = v.category_name || "-";
      else if (key === "color_id") field = v.color_name || "-";
      else field = val || "-";
    }

    return `<tr><th>${label}</th><td>${field}</td></tr>`;
  }
}

// ----------------------------------------
// ç”»åƒä¸€è¦§å–å¾—
// ----------------------------------------
async function fetchImages() {
  try {
    const res = await fetch(`/api/vehicles/${vehicleId}/images/`);
    const data = await res.json();

    // paginationå¯¾å¿œ: data.results ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
    const list = Array.isArray(data) ? data : data.results || [];
    renderImages(list);
  } catch (err) {
    console.error("ç”»åƒå–å¾—å¤±æ•—:", err);
  }
}


// ----------------------------------------
// ç”»åƒæç”»
// ----------------------------------------
function renderImages(list) {
  const div = document.getElementById("images");
  if (!list.length) {
    div.innerHTML = "<p>ç”»åƒã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
    return;
  }
  div.innerHTML = list.map(img => {
    // image_urlãŒå­˜åœ¨ã—ãªã‘ã‚Œã°imageã‚’ä½¿ã†ï¼ˆä¸¡å¯¾å¿œï¼‰
    const url = img.image_url || img.image;
    return `
      <div style="display:inline-block; margin:5px; text-align:center">
        <img src="${url}" style="width:150px; height:auto; border:1px solid #ccc; border-radius:4px; object-fit:contain"><br>
        <button class="btn btn-sm btn-danger mt-1" onclick="deleteImage(${img.id})">å‰Šé™¤</button>
      </div>
    `;
  }).join("");
}

// ----------------------------------------
// ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
// ----------------------------------------
document.getElementById("image-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fileInput = e.target.querySelector('input[name="image"]');
  const file = fileInput.files[0];
  if (!file) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

  const formData = new FormData();
  formData.append("image", file);

  try {
    const res = await fetch(`/api/vehicles/${vehicleId}/images/`, {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: formData,
    });
    if (!res.ok) throw new Error(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•— (${res.status})`);
    await fetchImages();
    fileInput.value = "";
    document.getElementById("image-errors").textContent = "";
  } catch (err) {
    document.getElementById("image-errors").textContent = err.message;
  }
});

// ----------------------------------------
// ç”»åƒå‰Šé™¤
// ----------------------------------------
async function deleteImage(id) {
  if (!confirm("å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  try {
    const res = await fetch(`/api/vehicles/${vehicleId}/images/${id}/`, {
      method: "DELETE",
      headers: { "X-CSRFToken": csrftoken },
    });
    if (!res.ok) throw new Error(`å‰Šé™¤å¤±æ•— (${res.status})`);
    await fetchImages();
  } catch (err) {
    alert(err.message);
  }
}
// ----------------------------------------
// è»Šä¸¡ãƒ¡ãƒ¢ ä¸€è¦§å–å¾—
// ----------------------------------------
async function fetchMemos() {
  try {
    const res = await fetch(`/api/vehicles/${vehicleId}/memos/`);
    const data = await res.json();

    // paginationå¯¾å¿œ
    const list = Array.isArray(data) ? data : data.results || [];
    renderMemos(list);
  } catch (err) {
    console.error("ãƒ¡ãƒ¢å–å¾—å¤±æ•—:", err);
    document.getElementById("memos").innerHTML =
      `<li style="color:#b00">ãƒ¡ãƒ¢å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</li>`;
  }
}

// ----------------------------------------
// ãƒ¡ãƒ¢æç”»
// ----------------------------------------
function renderMemos(list) {
  const ul = document.getElementById("memos");
  if (!list.length) {
    ul.innerHTML = "<li class='muted'>ãƒ¡ãƒ¢ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</li>";
    return;
  }

  ul.innerHTML = list
    .map(
      (m) => `
      <li style="margin-bottom:8px;border-bottom:1px solid #eee;padding-bottom:4px">
        <div><strong>${m.created_by || "ï¼ˆæŠ•ç¨¿è€…ä¸æ˜ï¼‰"}</strong>ã€€<span style="color:#888">${formatDate(m.created_at)}</span></div>
        <div style="white-space:pre-wrap;margin:4px 0">${m.body}</div>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteMemo(${m.id})">å‰Šé™¤</button>
      </li>`
    )
    .join("");
}

// ----------------------------------------
// ãƒ¡ãƒ¢è¿½åŠ 
// ----------------------------------------
document
  .getElementById("memo-form")
  .addEventListener("submit", async (e) => {
    e.preventDefault();
    const textarea = e.target.querySelector("textarea[name='body']");
    const body = textarea.value.trim();
    if (!body) return alert("ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

    const formData = new FormData();
    formData.append("body", body);

    try {
      const res = await fetch(`/api/vehicles/${vehicleId}/memos/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
        body: formData,
      });
      if (!res.ok) throw new Error(`è¿½åŠ å¤±æ•— (${res.status})`);
      textarea.value = "";
      document.getElementById("memo-errors").textContent = "";
      await fetchMemos();
    } catch (err) {
      document.getElementById("memo-errors").textContent = err.message;
    }
  });

// ----------------------------------------
// ãƒ¡ãƒ¢å‰Šé™¤
// ----------------------------------------
async function deleteMemo(id) {
  if (!confirm("ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  try {
    const res = await fetch(`/api/vehicles/${vehicleId}/memos/${id}/`, {
      method: "DELETE",
      headers: { "X-CSRFToken": csrftoken },
    });
    if (!res.ok) throw new Error(`å‰Šé™¤å¤±æ•— (${res.status})`);
    await fetchMemos();
  } catch (err) {
    alert(err.message);
  }
}

// ----------------------------------------
// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
// ----------------------------------------
function formatDate(dt) {
  const d = new Date(dt);
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(
    d.getDate()
  ).padStart(2, "0")} ${String(d.getHours()).padStart(2, "0")}:${String(
    d.getMinutes()
  ).padStart(2, "0")}`;
}

// ----------------------------------------
// åˆæœŸãƒ­ãƒ¼ãƒ‰ã«è¿½åŠ 
// ----------------------------------------
(async function init() {
  await fetchMasters();
  await fetchVehicle(vehicleId);
  await fetchImages();
  await fetchMemos(); // ğŸ‘ˆ ãƒ¡ãƒ¢ä¸€è¦§ã‚‚ãƒ­ãƒ¼ãƒ‰
})();

</script>
{% endblock %}
